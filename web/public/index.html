<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="/css/base.css">
    <script src="https://unpkg.com/realm-web/dist/bundle.iife.js"></script>
</head>

<body>
    <style>
        body {
            padding: 0px;
            margin: 0px;
        }
    </style>
    <div id="app"></div>
    <script src="/main.bundle.js"></script>
    <script>
        Promise.all([
            fetch('/translations.en.json')
                .then(response => response.json())
                .then((en) => ["en", en])
        ]).then((languages) => {
            const app = window.Elm.Main.init({
                node: document.getElementById('app'),
                flags: {
                    url: window.location.href,
                    languages,
                    clientId: crypto.randomUUID()
                }
            })

            app.ports.requestData.subscribe(function (k) {
                const v = window.localStorage.getItem(k)
                app.ports.receiveData.send([k, v])
            })

            app.ports.storeData.subscribe(function (k, v) {
                window.localStorage.setItem(k, v)
            })

            app.ports.replaceUrl.subscribe(function (url) {
                window.history.replaceState(null, document.title, url)
                requestAnimationFrame(function () {
                    app.ports.linkClicked.send(window.location.href)
                })
            })

            app.ports.startRealm.subscribe(function (jwt) {
                const app = new window.Realm.App({ id: "teo-web-ogsac" })

                const credentials = Realm.Credentials.jwt(jwt);

                app.logIn(credentials)
                    .then(function (res) {
                        const mongo = app.currentUser.mongoClient("Cluster0")
                        const events = mongo.db("public_db").collection("events")

                        events.insertOne({
                            name: "Test Event",
                            game: "Mortal Kombat"
                        })
                            .then(function (insertRes) {
                                console.log('SUCCESS: ', insertRes)
                            })
                            .catch(function (err) {
                                console.log('ERROR: ', err)
                            })
                    })
                    .catch(function (err) {
                        console.error(err)
                    })
            })
        })

        document.addEventListener('click', function (e) {
            let node = e.target
            while (node && node !== document && node !== document.body) {
                if (node.tagName === 'A' && node.getAttribute('data-link')) {
                    e.preventDefault()
                    if (node.getAttribute('data-link') === 'replaceState') {
                        window.history.replaceState(null, document.title, node.getAttribute('href'))
                    } else {
                        window.history.pushState(null, document.title, node.getAttribute('href'))
                    }
                    app.ports.linkClicked.send(window.location.href)
                    return
                }

                node = node.parentNode
            }
        })
    </script>
</body>

</html>